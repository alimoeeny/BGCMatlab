function ButtonReleased(src, data)DATA = GetDataFromFig(src);if DATA.elmousept.down == 0     return;endmode = DATA.elmousept.down;start = get(gca,'CurrentPoint');DATA.elmousept.done = 1;if DATA.elmousept.down == 5    p = FitEllipse(DATA.elmousept.pts,'aspectratio',DATA.elmousept.aspectratio);    if DATA.profiling        fprintf('%.2f %.2f %.2f %.2f %.2f Ar %.2f\n',p,DATA.elmousept.aspectratio);        FitEllipse(DATA.elmousept.pts,'aspectratio',DATA.elmousept.aspectratio,'show');    end    DATA.elmousept.xyr = p;    DATA.elmousept.pos = [NaN NaN NaN NaN];    DATA.elmousept.angle = p(5);    figure(gcbf);    DATA.elmousept.h = AllV.DrawEllipse(DATA.elmousept, DATA.elmousept.plotargs{:});    hold on;    plot(DATA.elmousept.pts(:,1),DATA.elmousept.pts(:,2),'-','color',get(DATA.elmousept.h,'color'));    hold off;else    p = DATA.elmousept.pos;endDATA.elmousept.down = 0;dx = start(1,1:2) - DATA.elmousept.start;xl = get(gca,'xlim');yl = get(gca,'ylim');d = (dx(1)./diff(xl)).^2 + (dx(2)./diff(yl)).^2 ;if DATA.profiling    fprintf('Finish at %.3f %.3f %.3f %.3f D%.3f\n',p,d);endif (p(3) ==0 && p(4) == 0) || d < 0.002 %not moved - just press and release    if DATA.profiling        fprintf('MOuse not moved. Just selected cluster %d (took %.2f)\n',DATA.elmousept.newcluster,mytoc(DATA.elmousept.downtime));    end    if isfield(DATA.elmousept,'newcluster') && DATA.elmousept.newcluster > 0        ts = now;        DATA = AllV.SetEllipseDrawing(DATA,0,'cluster',DATA.elmousept.newcluster,'interactive');        if DATA.profiling            fprintf('SetEllipse Took %.2f\n',mytoc(ts));        end        SetData(DATA);        return;    endendDATA = AllV.SetSpaceFromAxis(DATA, gca);if isappdata(src,'ClusterSpace')    DATA.elmousept.space = getappdata(src,'ClusterSpace');elseif length(DATA.elmousept.pcplot) > 2 && isnan(DATA.elmousept.pcplot(1))    DATA.elmousept.space = DATA.elmousept.pcplot(2:end);elseif length(DATA.elmousept.pcplot) == 3    DATA.elmousept.space = DATA.elmousept.pcplot;    DATA.elmousept.pcspace = DATA.elmousept.pcplot(1);    DATA.elmousept.pcplot = DATA.elmousept.pcplot(2:3);else    DATA.elmousept.pcspace = DATA.plottype;    DATA.elmousept.space = [DATA.plottype DATA.elmousept.pcplot];endif mode == 1    DATA.elmousept.xyr = [mean(p([1 3])) mean(p([2 4])) abs(diff(p([1 3]))/2) abs(diff(p([2 4]))/2)]; elseif mode == 2  %button was pressed inside ellipse, just move it    DATA.elmousept.xyr = [mean(p([1 3])) mean(p([2 4])) abs(diff(p([1 3]))/2) abs(diff(p([2 4]))/2)]; endxyr = DATA.elmousept.xyr;set(DATA.toplevel,'UserData',DATA);%touch inside ellispe to make cut. If drawing a line, make cut when%releasedif mode == 2  || DATA.elmousept.shape  ==1     if strncmp(DATA.elmousept.type,'gmm',3)        AllV.GMMButton(DATA, DATA.elmousept,DATA.elmousept.type);    else        AllV.PCCluster(DATA,DATA.elmousept,1);    endend