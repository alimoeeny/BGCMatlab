function [h, details]= DrawEllipse(E,varargin)% [h, details]= DrawEllipse(E,varargin) Draw Ellipse or Line%h = [];details = [];if E.shape == 1    h = AllV.DrawLine(E,varargin{:});    return;end[a,b] = cellstrcmp('setx',varargin);if a    xvals = varargin{find(b)+1};else    xvals = [];endif isfield(E,'ellipse') && E.auto > 0    if isempty(E.ellipse.xy)        cprintf('red','Cannot Draw ellipse\n');        return;    end    a = E.ellipse.xy(3); %radius    b = E.ellipse.xy(4);    cntr = E.ellipse.xy([1 2]);    E.angle = E.ellipse.xy(5);        if ~isfield(E,'aspectratio')        E.aspectratio = 1;    endelseif isfield(E,'pos') && sum(isnan(E.pos)) ==0    a = (E.pos(3)-E.pos(1))/2; %radius    b = (E.pos(4)-E.pos(2))/2;    cntr(1) = mean(E.pos([1 3]));    cntr(2) = mean(E.pos([2 4]));elseif isfield(E,'xyr')    a = E.xyr(3);    b = E.xyr(4);    cntr(1) = E.xyr(1);    cntr(2) = E.xyr(2);else %can't draw ellips with no dimensions    return;end    sn = 0;cn = 1;if ~isfield(E,'color')    E.color = 'k';endif isempty(xvals)    x = linspace(0,a);else    x = xvals;endsn = sin(E.angle);cn = cos(E.angle);a = abs(a);b = abs(b);if isfield(E,'aspectratio') && E.aspectratio > 0    b  = b ./E. aspectratio;    y =  real(sqrt(b.^2 - (x.*b/a).^2));else    y =  real(sqrt(b.^2 - (x.*b/a).^2));endx = [x fliplr(x) -x fliplr(-x)];y = [y fliplr(-y) -y fliplr(y)];dx=abs(a + i.*b)/20;%dx=0;if dx > 0  %don't add box when noplot x = [x x(end)+[-dx -dx dx dx -dx 0]]; y = [y y(end)+[-dx dx dx -dx -dx 0]];endxr = (x .* cn + y .*sn);yr = (y .* cn - x .*sn);x = xr+cntr(1);if isfield(E,'aspectratio') && E.aspectratio > 0    y = yr.*E.aspectratio+cntr(2);    aspect = E.aspectratio;else    aspect = 1;    y = yr+cntr(2);endif dx > 0    details.x = x(1:end-6); %remove marking box    details.y = y(1:end-6);else    details.x = x;    details.y = y;enddetails.xyr = [cntr a b E.angle aspect];details.markpt = [x(end) y(end)];details.extent = [minmax(x); minmax(y)];if cellstrcmp('noplot',varargin)    return;endif isfield(E,'h') & ishandle(E.h)  & get(E.h,'parent') == gca%    fprintf('Using handle %f\n',get(E.h,'parent'));    set(E.h,'Xdata',x,'Ydata',y,'color',E.color);    h = E.h;else    hold on;    h = plot(real(x),real(y),'color',E.color,varargin{:});%    plot(x(end),y(end),'s','color',E.color,'markerfacecolor',E.color);    hold off;end