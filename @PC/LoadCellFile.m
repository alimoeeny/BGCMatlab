function DATA = LoadCellFile(DATA, varargin)showplot = 'off';j = 1;while j <= length(varargin)    if strcmp(varargin{j},'plot')        showplot = 'image';    end    j = j+1;end    if ischar(DATA)        name = DATA;        clear DATA;        DATA.name = name;        DATA.cellbackup = NaN;        DATA.tag.celllist = ['CellList ' GetName(name)];        DATA.markcell.dropi = 1;        DATA.markcell = AddField(DATA.markcell,{'candidates' 'goodmu' 'auto' 'mahal' 'tagged' 'ellipses' 'readmethod' 'quick' 'expnames'},0);        DATA.clusteroffset = 0;        DATA.ArrayConfig = GetArrayConfig(name);        DATA.plot.cellgrid = 0;        DATA.show.ed = 0;        DATA.selectprobe = [];        DATA.crit.dropi = 1.5;        DATA.currentcell = 1;        DATA.profiling = 0;    end    cellfile = [DATA.name '/CellList.mat'];    if isfield(DATA,'toplevel')        Expts = getappdata(DATA.toplevel,'Expts');    else        Expts = {};    end    if exist(cellfile,'file')        load(cellfile);        d = dir(cellfile);        dstr = datestr(d.date);        dstr = dstr([1:2 4:6]);        nr = min([length(Expts) size(CellList,1)]);        %Dangerous to  change size of celllist. It will be written out again and so%might overwrite datat that is wanted, just becuase and Expt is temporarily%missing%        DATA.CellList = CellList(1:nr,:);        DATA.CellList = CellList;        DATA.CellDetails = CellDetails;        DATA.CellDetails.loadname = cellfile;        if ~isfield(CellDetails,'excludetrials')            DATA.CellDetails.excludetrials = {};        end        if isfield(CellDetails,'Quality')            CellDetails.Quality = zeros(size(CellList));            id = find(CellList > 0);            CellDetails.Quality(id) = 4;        end% If all expts not loaded yet, can't check the exptid list.% exptid = Nan inidicates this has happened        if ~isempty(Expts)        for j = 1:length(Expts)            if isfield(Expts{j},'Header')                exptids(j) = Expts{j}.Header.exptno;            else                exptids(j) = NaN;            end        end        exid = exptids(~isnan(exptids)); %list of available expts        missing = setdiff(exid,DATA.exptid);        exid = intersect(exid,DATA.exptid); %expts for which there is ClusterTimes data        if ~isempty(missing)            DATA = AddError(DATA,'Missing ClusterTimes for Expts%s',sprintf(' %d',missing));                    end        if ~isfield(CellDetails,'exptids')                    DATA.CellDetails.exptids = exid;        elseif exist('exptids','var')  % check expt list matched            [id, ia, ib] = setxor(CellDetails.exptids,exid);            if length(ib) % new expts                fprintf('Adding Expts %s to CellList\n',sprintf('%d ',ib));                id = find(ismember(exid,CellDetails.exptids));                DATA.CellList(id,:,:) = CellList;                DATA.CellList(ib,:,:) = 0;                DATA.CellDetails.exptids = exid;                CellDetails = rmfields(CellDetails,'trialids'); %rebuild below            end        end        if ~isempty(Expts) && isfield(Expts{j},'Trials')        if ~isfield(CellDetails,'trialids')             for j = 1:length(Expts)                n = GetExptNumber(Expts{j});                id = find(ismember(DATA.CellDetails.exptids,n));                if isfield(Expts{j},'Trials') && ~isempty(id)                    DATA.CellDetails.trialids{id} = [Expts{j}.Trials.id];                end            end        else            for j = 1:length(Expts)                if isfield(Expts{j},'Trials')                Tn = [Expts{j}.Trials.id];                n = GetExptNumber(Expts{j});                id = find(ismember(DATA.CellDetails.exptids,n));                                if ~isempty(id)                    DATA.CellDetails.trialids{id} = Tn;                    [a,b,c] = setxor(DATA.CellDetails.trialids{id},Tn);                    if length(a) > 0 && j <= size(DATA.CellDetails.excludetrials,1)                        fprintf('Expt Trial List Changed for Expt %d (%d gone, %d new)\n',Expts{j}.Header.exptno,length(b),length(c));                        for k = 1:size(DATA.CellDetails.excludetrials,2)                            if ~isempty(DATA.CellDetails.excludetrials{j,k,1})                                [a, id] = ismember(Tn,DATA.CellDetails.excludetrials{j,k,1});                            end                        end                    end                end                end            end        end        end        end        if exist('muCellList','var')            DATA.muCellList = muCellList;        end                if isfield(DATA,'exptid')            extras = setdiff(DATA.CellDetails.exptids,DATA.exptid);        else            extras = [];        end        keepchecking = 1;        for j = 1:length(extras)            eid = find(DATA.CellDetails.exptids == extras(j));            ncells = sum(sum(DATA.CellList(eid,:,:)));            if keepchecking                if ncells == 0                    str = sprintf('Expt %d (row %d) In Cell List but empty and does not Have Clusters\nProbably Means AutoClusters Needed - try ''loadauto''\nOr Expt has beed deleted\nDelete Form CellList?',extras(j),eid);                else                    str = sprintf('Expt %d (row %d) In Cell List and has %d cells defined but does not Have Clusters\nProbably Means AutoClusters Needed - try ''loadauto''\nOr Expt has beed deleted\nDelete Form CellList?',extras(j),eid,ncells);                end                yn = questdlg(str, 'Confirm Popup', 'Yes', 'No','No to All', 'Yes');                if strcmp(yn,'Yes')                    gid = setdiff(1:size(DATA.CellList,1),eid);                    DATA.CellList(eid,:,:) = [];                    DATA.CellDetails.exptids(eid) = [];                    DATA.CellDetails.Quality(eid,:,:) = [];                    if size(DATA.CellDetails.excludetrials,1) >= eid                        DATA.CellDetails.excludetrials = DATA.CellDetails.excludetrials{gid,:,:};                    end                    if isfield(DATA.CellDetails,'trialids')                         DATA.CellDetails.trialids(eid) = [];                    end                    if isfield(DATA,'muCellList') && size(DATA.muCellList,1) >= eid                        DATA.muCellList(eid,:,:) = [];                    end                elseif strcmp(yn,'Fix')                    eid = find(DATA.CellDetails.exptids == extras(j));                                    elseif strcmp(yn,'No to All')                    keepchecking = 0;%                    DATA.exptid = DATA.CellDetails.exptids;                end            end        end        DATA = PC.ConvertExclusion(DATA);        if exist('CellListB','var')            DATA.CellList(1:size(CellListB,1),1:size(CellListB,2),2) = CellListB;        end        if exist('CellChanges','var')            DATA.CellChanges = CellChanges;            if size(DATA.CellChanges,2) < 6                DATA.CellChanges(:,6) = NaN;            end        else            CellChanges = [];        end        if DATA.cellbackup == 0 %not backed up, so do this now            bakfile = strrep(cellfile,'.mat',[dstr '.mat']);            try                save(bakfile,'CellList','CellDetails','CellChanges');            catch                cprintf('red','COuld not back up Cell list to %s\n',bakfile);            end            DATA.cellbackup = 1;            set(DATA.toplevel,'UserData',DATA);        end    elseif isfield(DATA,'exptid')        DATA.CellList = zeros([length(DATA.exptid) DATA.nprobes 2]);        DATA.CellDetails.exptids = DATA.exptid;    endif strcmp(showplot,'image')    PC.PlotCellList(DATA);end