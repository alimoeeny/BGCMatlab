function Expt = CountExptSpikes(DATA,Expt,C,clnum, varargin)%Expt = PC.CountExptSpikes(DATA,Expt,C,clnum)%finds spikes in C that match trials in Expt, and%adds them to the Expt.Trials strucutre.%clnum 1 = cluster 1, i.e. C.clst == 2strargs = cell2cellstr(varargin);fixrate = 0;j = 1;while j <= length(varargin)    if strcmp(varargin{j},'fixrate')        j = j+1;        fixrate = varargin{j};    end    j = j+1;endfillmu = sum(strcmp('fillmu',strargs));    if isempty(Expt) || isempty(C)        Expt.Header.cellnumber = 0;        Expt.Header.probe = 0;        return;    end    preperiod = 1000;    postperiod = 1000;    CellList = PC.GetValue(DATA,'CellList');    cellid = CellList(C.exptid,C.probe(1),clnum);    if cellid > 0        xcl = PC.FindExcludedTrials(DATA,C.exptid,C.probe(1),clnum,C);        xid = [Expt.Trials(xcl).id];        Expt.Header.cellnumber = cellid;    else        xid = [];        Expt.Header.cellnumber = 0;    end    Expt.Header.probe = C.probe(1);    if fixrate > 0        C = clust.FixRate(C, clnum, fixrate);        if isfield(C,'fixrateerror')            cprintf('red','Error adjusting MU Rate %s\n',str(C));        end    end    Expt = PC.CountSpikes(Expt, C, clnum, xid, varargin{:});    return;%%%This is old ant not used!!                spkt = C.times(C.clst == clnum) .*10000;    if fillmu        muid = cind(C.clst ~= clnum);        mutimes = C.times(muid);    end     for j = 1:length(Expt.Trials)         id = find(spkt > Expt.Trials(j).Start(1)-preperiod & spkt < Expt.Trials(j).End(end)+postperiod);         Expt.Trials(j).Spikes = round(spkt(id)'-Expt.Trials(j).Start(1));         Expt.Trials(j).count = sum(spkt(id) > 500 & spkt(id) < Expt.Trials(j).dur+500);         if fillmu             id = find(mutimes > Expt.Trials(j).Start(1) & mutimes < Expt.Trials(j).End(end));             Expt.Trials(j).OSpikes = round(mutimes(id)'-Expt.Trials(j).Start(1));             Expt.Trials(j).OCodes = C.clst(id);         end     end    