function Expt = PlotCombinedExpt(DATA, varargin)strargs = cell2cellstr(varargin);[exid, pid] = find(DATA.selectprobe);Clusters = PC.CheckClusterLoaded(DATA,exid);Expts = getappdata(DATA.toplevel,'Expts');clusterid = 1;PC.SetFigure(DATA,DATA.tag.expt);args = {'shown'};if sum(strncmp('allcells',strargs,8))    if sum(strncmp('allcellsmu',strargs,10))        DATA.makemu = 1;    else        DATA.makemu = 0;    end       Expt = CombineCells(DATA, Clusters, Expts, exid);   return;end    if length(clusterid) == 1        clusterid = ones(size(exid)).* clusterid;    end    h = [];    exptid = DATA.exptid(exid);    for j = 1:length(exid)        E{j} = PC.CountExptSpikes(DATA, Expts{exptid(j)},Clusters{exid(j)}{pid(j)},clusterid(j));    end    Expt = CombineExpts(E);    res = PlotExpt(Expt,'fbox',args{:});    Expt.plotres = rmfields(res,'Data');    setappdata(DATA.toplevel,'CombinedExpt',Expt);    rmappdata(DATA.toplevel,'Expt'); %Don't need both. Now expt.GetExpt gets the combined expt    function Expt = CombineCells(DATA, Clusters, Expts, exid)                plotresults = 0;%when debugging set profiining (PlotClusters(F,[],'profile') so that%do not keep writing file        if DATA.profiling            savefile = 0;        else            savefile = 1;        end        if isfield(DATA,'makemu')            makemu = DATA.makemu;        else            makemu = 0;        end        C = PC.GetValue(DATA,'CellList');    cells = unique(C(exid,:,:));    cells = cells(cells>0);    exptid = DATA.exptid(exid);        for c = 1:size(cells)        H.Cluster = {};        clear E;        good = 0;        [p,cl] = celllist.find(C,cells(c),'expts',exid);        fprintf('Building Combined Expt for Cell %d P%.1f\n',cells(c),mean(p));        for j = 1:length(exid)            [p,cl] = find(squeeze(C(exid(j),:,:)) == cells(c));            if ~isempty(p)                E{j} = PC.CountExptSpikes(DATA, Expts{exptid(j)},Clusters{exid(j)}{p},cl,'fillmu');                Ca = PC.GetClusterInfo(DATA, [exid(j) p cl]);                H.Cluster{j}.probe = p;                H.Cluster{j} = CopyFields(H.Cluster{j},Ca,{'excludetrials' 'missingtrials' 'user' 'cluster'});                if isfield(Ca,'savetime')                    H.Cluster{j}.savetime = Ca.savetime(end);                    H.Cluster{j}.dropi = Ca.dropi(3);                    H.Cluster{j}.dips = cmb.GetDips(Ca);                else                    fprintf('Missing Cluster Info for E%dCell%d P%d.%d\n',exid(j),cells(c),p,cl);                end                good(j) = 1;            end        end        gid = find(good);    Expt{c} = CombineExpts(E(gid));    Expt{c}.Header.Clusters = H.Cluster(gid);    Expt{c}.Header.nspk = sum([Expt{c}.Trials.count]);    meanrates(cells(c)) = 10000.* Expt{c}.Header.nspk./sum([Expt{c}.Trials.dur]);     if plotresults        PlotExpt(Expt{c},'fbox','rcnmin',2);    end    end        AllExpt = expt.MakeAllExpt(Expt);    outname = BuildFileName(AllExpt,'allexpt');    AllExpt.Expt.Header.loadname = outname;    if savefile        BackupFile(outname,'print');        fprintf('Saving %d cells in %s\n',length(Expt),outname);        save(outname,'AllExpt');    end    setappdata(DATA.toplevel,'AllExpt',AllExpt);        if makemu        muprobes = sum(C(exid,:,:) ~= 0,3);        mucount = sum(muprobes ==0);  %# of expts that are MU for each probe        usemu = find(mucount > length(exid)/2);        mid = find(DATA.muCellList(exid,:,:)>0);        [muex, muprobe, mucl] = ind2sub(size(DATA.muCellList(exid,:,:)),mid);        usemu = unique([usemu unique(muprobe)']);        for c = 1:length(usemu)            E = {};            p = usemu(c);            fprintf('Building Combined Expt for MU probe %.1f\n',p);            mid = find(muprobes(:,usemu(c))==0);            xid = find(muprobe == p);            mid = cat(1,mid ,unique(muex(xid)));            muforcell = 0;            for j = 1:length(mid)                xid = find(DATA.muCellList(exid(mid(j)),usemu(c),:) > 0);                if isempty(xid)                    cl = 1;                    muforcell(j) = 0;                else                    cl = xid(1);                    muforcell(j) = DATA.muCellList(exid(mid(j)),usemu(c),xid(1));                end                Ca = PC.GetClusterInfo(DATA, [exid(mid(j)) usemu(c) cl]);                H.Cluster{j}.probe = usemu(c);                H.Cluster{j} = CopyFields(H.Cluster{j},Ca,{'excludetrials' 'missingtrials' 'user' 'cluster'});                if muforcell(j)%meanrates are calculated when building cells above.                                         E{j} = PC.CountExptSpikes(DATA, Expts{exptid(mid(j))},Clusters{exid(mid(j))}{p},cl,'fillmu','fixrate',meanrates(muforcell(j)));                else                    E{j} = PC.CountExptSpikes(DATA, Expts{exptid(mid(j))},Clusters{exid(mid(j))}{p},cl,'fillmu');                end            end            if ~isempty(E)            muExpt{c} = CombineExpts(E);            muExpt{c}.Header.Clusters = H.Cluster;            muExpt{c}.Header.nspk = sum([muExpt{c}.Trials.count]);            muExpt{c}.Header.muforcell = muforcell;            end        end        AllMU = expt.MakeAllExpt(muExpt);        outname = BuildFileName(AllMU,'allexpt');        AllMU = rmfields(AllMU, 'Expt');        if savefile            outname = strrep(outname,'.Cells.','.MU.');            BackupFile(outname,'print');            fprintf('Saving %d MU probes in %s\n',length(muExpt),outname);            save(outname,'AllMU');        end        setappdata(DATA.toplevel,'AllMU',AllMU);    end        